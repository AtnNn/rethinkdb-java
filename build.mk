# Copyright 2010-2015 RethinkDB

JAVA_SRC_DIR=$(TOP)/drivers/java
JAVA_BUILD_DIR=$(TOP)/build/drivers/java
JAVA_PKG_DIR=$(TOP)/build/package/java

PACKAGE_DIR=$(JAVA_SRC_DIR)/src/main/java/com/rethinkdb

GEN_DIR=$(PACKAGE_DIR)/gen
PROTO_DIR=$(GEN_DIR)/proto
AST_DIR=$(GEN_DIR)/ast
MODEL_DIR=$(GEN_DIR)/model
EXC_DIR=$(GEN_DIR)/exc
TEST_DIR=$(JAVA_SRC_DIR)/src/test/java
TEST_GEN_DIR=$(TEST_DIR)/gen

METAJAVA=$(JAVA_SRC_DIR)/metajava.py
CONVERT_PROTO=$(JAVA_SRC_DIR)/convert_protofile.py
CONVERT_TESTS=$(JAVA_SRC_DIR)/convert_tests.py

TEMPLATE_DIR=$(JAVA_SRC_DIR)/templates
PROTO_FILE=$(TOP)/src/rdb_protocol/ql2.proto
PROTO_JSON=$(JAVA_SRC_DIR)/proto_basic.json
TERM_INFO=$(JAVA_SRC_DIR)/term_info.json
JAVA_TERM_INFO=$(JAVA_BUILD_DIR)/java_term_info.json
GLOBAL_INFO=$(JAVA_SRC_DIR)/global_info.json

GRADLE=gradle --build-file=$(JAVA_SRC_DIR)/build.gradle       \
	      --settings-file=$(JAVA_SRC_DIR)/settings.gradle \
	      --quiet

.PHONY: java-driver
java-driver: autogenerated-classes | $(JAVA_BUILD_DIR)/.
	$P GRADLE ASSEMBLING JAVA DRIVER
	$(GRADLE) assemble

.PHONY: java-clean
java-clean:
	$P CLEAN
	$(GRADLE) clean
	rm -rf $(JAVA_BUILD_DIR)

.PHONY: java-super-clean
# this deletes all generated files, even ones checked into git
java-super-clean: | java-clean
	$P SUPER-CLEAN
	rm -rf $(GEN_DIR)/*
	rm -rf $(TEST_GEN_DIR)/*

.PHONY: java-convert-tests
java-convert-tests: py-driver
	$P CONVERT JAVA TESTS
	$(CONVERT_TESTS) \
	    --test-dir=$(TOP)/test/rql_test/src             \
	    --python-driver-dir=$(TOP)/build/drivers/python \
	    --test-output-dir=$(TEST_GEN_DIR)               \
	    --template-dir=$(TEMPLATE_DIR)                  \

.PHONY: java-test
java-test: | java-convert-tests
	$P JAVA DRIVER TESTS
	$(GRADLE) test

$(JAVA_BUILD_DIR) $(GEN_DIR) $(PROTO_DIR) $(AST_DIR) $(EXC_DIR) $(MODEL_DIR) $(TEST_GEN_DIR):
	$P MKDIR $@
	mkdir -p $@

$(PROTO_JSON): $(PROTO_FILE) $(CONVERT_PROTO)
	$P CONVERT PROTOFILE
	$(PYTHON) $(CONVERT_PROTO) $(PROTO_FILE) $(PROTO_JSON)

$(TERM_INFO): $(PROTO_JSON) $(METAJAVA)
	$P UPDATING $(notdir $@)
	$(PYTHON) $(METAJAVA) update-terminfo	\
		--term-info=$(TERM_INFO)	\
		--proto-json=$(PROTO_JSON)

$(JAVA_TERM_INFO): $(TERM_INFO) $(METAJAVA) | $(JAVA_BUILD_DIR)/.
	$P GENERATING JAVA TERM INFO
	$(PYTHON) $(METAJAVA) generate-java-terminfo	\
		--term-info=$(TERM_INFO)		\
		--output-file=$@

.PHONY: autogenerated-classes
autogenerated-classes: $(JAVA_TERM_INFO) $(GLOBAL_INFO) $(METAJAVA) \
	| $(MODEL_DIR) $(AST_DIR) $(PROTO_DIR) $(EXC_DIR)
	$P GENERATING JAVA CLASSES
	$(PYTHON) $(METAJAVA) generate-java-classes	\
		--global-info=$(GLOBAL_INFO)		\
		--proto-json=$(PROTO_JSON)		\
		--java-term-info=$(JAVA_TERM_INFO)	\
		--template-dir=$(TEMPLATE_DIR)		\
		--package-dir=$(PACKAGE_DIR)
